@model IEnumerable<CÃ¼zdan_UygulamasÄ±.BusinessLogic.DTOs.InstallmentDto>
@{
    ViewData["Title"] = "Taksitli AlÄ±ÅŸveriÅŸler";
}


<div class="container-fluid px-4">
    <!-- Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="mb-0">ðŸ›’ Taksitli AlÄ±ÅŸveriÅŸler</h2>
                <p class="text-muted mb-0">Taksitli Ã¶demelerinizi takip edin ve yÃ¶netin</p>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <a asp-action="Create" class="btn-primary-action">
                        <i class="bi bi-plus me-2"></i>Yeni Taksit
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-primary"><i class="bi bi-list fa-2x mb-2"></i></div>
                    <h6 class="text-muted">Toplam Taksit</h6>
                    <h4 class="text-primary">@Model.Count()</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-warning"><i class="bi bi-clock fa-2x mb-2"></i></div>
                    <h6 class="text-muted">Aktif Taksit</h6>
                    <h4 class="text-warning">@Model.Count(i => !i.IsCompleted)</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-success"><i class="bi bi-check-circle fa-2x mb-2"></i></div>
                    <h6 class="text-muted">Tamamlanan</h6>
                    <h4 class="text-success">@Model.Count(i => i.IsCompleted)</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-info"><i class="bi bi-currency-dollar fa-2x mb-2"></i></div>
                    <h6 class="text-muted">Toplam Tutar</h6>
                    <h4 class="text-info">â‚º@Model.Sum(i => i.TotalAmount).ToString("N2")</h4>
                </div>
            </div>
        </div>
    </div>

    <div>
        <h5>Taksitler</h5>
    </div>

    <!-- Installments List -->
    <div class="row">
        <div class="col-12">
            @if (Model.Any())
            {
                <div class="item-list">
                @foreach (var installment in Model.OrderBy(i => i.NextPaymentDate))
                {
                    var progressPercentage = installment.TotalInstallments > 0
                    ? ((double)(installment.TotalInstallments - installment.RemainingInstallments) /
                    installment.TotalInstallments) * 100
                    : 0;

                    var cardClass = installment.IsCompleted ? "completed" :
                    (installment.NextPaymentDate < DateTime.Now ? "overdue" : "active");

                    <div class="item-card item-card--installment @cardClass">
                        <div class="item-inner">
                            <!-- Avatar with Progress Ring -->
                            <div class="item-avatar item-avatar--installment" data-progress="@progressPercentage.ToString("F1")">
                                <div class="progress-ring">
                                    <svg class="progress-ring__svg" width="44" height="44">
                                        <circle class="progress-ring__circle-bg" cx="22" cy="22" r="18"/>
                                        <circle class="progress-ring__circle" cx="22" cy="22" r="18" 
                                                style="stroke-dasharray: @(2 * Math.PI * 18); stroke-dashoffset: @(2 * Math.PI * 18 * (100 - progressPercentage) / 100);"/>
                                    </svg>
                                    <div class="progress-ring__icon">
                                        @if (installment.IsCompleted)
                                        {
                                            <i class="bi bi-check"></i>
                                        }
                                        else if (installment.NextPaymentDate < DateTime.Now)
                                        {
                                            <i class="bi bi-exclamation-triangle"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-credit-card"></i>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="item-content">
                                <p class="title">@installment.Description</p>
                                <p class="meta">
                                    @installment.RemainingInstallments / @installment.TotalInstallments taksit kaldÄ±
                                    â€¢ â‚º@installment.MonthlyPayment.ToString("N2") aylÄ±k
                                    @if (installment.Category != null)
                                    {
                                        <span class="item-chip"><i class="bi bi-tag"></i> @installment.Category.Name</span>
                                    }
                                    @if (installment.IsCompleted)
                                    {
                                        <span class="item-chip item-chip--success"><i class="bi bi-check"></i> TamamlandÄ±</span>
                                    }
                                    else if (installment.NextPaymentDate < DateTime.Now)
                                    {
                                        <span class="item-chip item-chip--danger"><i class="bi bi-exclamation-triangle"></i> GecikmiÅŸ</span>
                                    }
                                    else
                                    {
                                        <span class="item-chip item-chip--primary"><i class="bi bi-clock"></i> @installment.NextPaymentDate.ToString("dd MMM")</span>
                                    }
                                </p>
                                
                                <!-- Interactive Progress Bar -->
                                <div class="installment-progress" data-percentage="@progressPercentage.ToString("F1")" 
                                     data-paid="@installment.TotalPaid.ToString("N2")" 
                                     data-remaining="@installment.RemainingAmount.ToString("N2")">
                                    <div class="progress-bar-interactive">
                                        <div class="progress-fill-interactive" style="width: @(progressPercentage.ToString("F1"))%"></div>
                                        <div class="progress-tooltip">
                                            <strong>@(progressPercentage.ToString("F1"))% tamamlandÄ±</strong><br>
                                            Ã–denen: â‚º@installment.TotalPaid.ToString("N2")<br>
                                            Kalan: â‚º@installment.RemainingAmount.ToString("N2")
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Amount -->
                            <div class="item-amount">
                                <p class="value">â‚º@installment.TotalAmount.ToString("N2")</p>
                                <small class="text-muted">toplam</small>
                            </div>

                            <!-- Actions -->
                            <div class="item-actions">
                                @if (!installment.IsCompleted)
                                {
                                    <a asp-action="Pay" asp-route-id="@installment.Id"
                                        class="btn-success-action btn-sm" title="Ã–deme Yap">
                                        <i class="bi bi-credit-card"></i><span>Ã–deme Yap</span>
                                    </a>
                                }
                                <a asp-action="Details" asp-route-id="@installment.Id"
                                    class="btn-view-action btn-sm" title="Detay">
                                    <i class="bi bi-eye"></i><span>Detay</span>
                                </a>
                                <a asp-action="Edit" asp-route-id="@installment.Id"
                                    class="btn-edit-action btn-sm" title="DÃ¼zenle">
                                    <i class="bi bi-pencil"></i><span>DÃ¼zenle</span>
                                </a>
                                <button type="button"
                                        class="btn-danger-action btn-sm"
                                        onclick="deleteInstallment(@installment.Id)"
                                        title="Sil">
                                    <i class="bi bi-trash"></i><span>Sil</span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
                </div> <!-- /.item-list -->
            }
            else
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body empty-state">
                        <i class="bi bi-cart fa-4x mb-3"></i>
                        <h4>HenÃ¼z taksit bulunmuyor</h4>
                        <p>Ä°lk taksitli alÄ±ÅŸveriÅŸinizi ekleyerek baÅŸlayÄ±n.</p>
                        <a asp-action="Create" class="btn-primary-action">
                            <i class="bi bi-plus me-2"></i>Ä°lk Taksitimi Ekle
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        @if (TempData["Success"] != null)
        {
            <text>
            Swal.fire({
                icon: 'success',
                title: 'BaÅŸarÄ±lÄ±!',
                text: '@Html.Raw(TempData["Success"])',
                timer: 3000,
                showConfirmButton: false
            });
            </text>
        }
        
        @if (TempData["Error"] != null)
        {
            <text>
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: '@Html.Raw(TempData["Error"])'
            });
            </text>
        }
    </script>
}
