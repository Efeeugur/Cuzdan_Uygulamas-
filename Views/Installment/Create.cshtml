@model CÃ¼zdan_UygulamasÄ±.BusinessLogic.DTOs.CreateInstallmentDto
@{
    ViewData["Title"] = "Yeni Taksitli AlÄ±ÅŸveriÅŸ";
    var categories = ViewBag.Categories as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
}

@section Styles {
    <link rel="stylesheet" href="~/css/shared.css" />
    <link rel="stylesheet" href="~/css/installment.css" />
}


<div class="container-fluid px-4">
    <div class="form-container">
        <div class="form-header">
            <h2 class="mb-2">
                <i class="bi bi-cart form-icon"></i>
                Yeni Taksitli AlÄ±ÅŸveriÅŸ
            </h2>
            <p class="text-muted mb-0">Taksitli Ã¶demelerinizi takip etmek iÃ§in yeni bir alÄ±ÅŸveriÅŸ ekleyin</p>
        </div>

        <div class="form-body">
            <div class="installment-info">
                <div class="d-flex align-items-center">
                    <i class="bi bi-magic me-2"></i>
                    <div>
                        <strong>ðŸŽ¯ AkÄ±llÄ± Taksit Sistemi</strong>
                        <div class="small">Kategori seÃ§tiÄŸinizde piyasa faiz oranÄ± otomatik olarak belirlenir.
                            Ä°stediÄŸiniz zaman manuel olarak deÄŸiÅŸtirebilirsiniz.</div>
                        <div class="small mt-1">
                            <strong>ðŸ’¡ Ä°pucu:</strong> FarklÄ± kategoriler iÃ§in farklÄ± faiz oranlarÄ± uygulanÄ±r (Ã¶rn:
                            otomobil %0.99, elektronik %1.99).
                        </div>
                    </div>
                </div>
            </div>

            <form asp-action="Create" method="post" novalidate>
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row">
                    <div class="col-md-8 mb-4">
                        <label asp-for="Description" class="form-label">
                            <i class="bi bi-pencil form-icon"></i>AlÄ±ÅŸveriÅŸ AÃ§Ä±klamasÄ± *
                        </label>
                        <input asp-for="Description" class="form-control"
                            placeholder="Ã¶rn: Laptop, BuzdolabÄ±, Televizyon" />
                        <span asp-validation-for="Description" class="text-danger"></span>
                        <div class="form-help">Neyi taksitle aldÄ±ÄŸÄ±nÄ±zÄ± belirtin</div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <label asp-for="TotalAmount" class="form-label">
                            <i class="bi bi-currency-dollar form-icon"></i>Toplam Tutar *
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">â‚º</span>
                            <input asp-for="TotalAmount" class="form-control" placeholder="0,00" step="0.01"
                                type="number" onchange="calculateInstallment()" />
                        </div>
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label asp-for="TotalInstallments" class="form-label">
                            <i class="bi bi-calendar2 form-icon"></i>Taksit SayÄ±sÄ± *
                        </label>
                        <select asp-for="TotalInstallments" class="form-select" onchange="calculateInstallment()">
                            <option value="">Taksit sayÄ±sÄ± seÃ§in...</option>
                            <option value="2">2 Taksit</option>
                            <option value="3">3 Taksit</option>
                            <option value="6">6 Taksit</option>
                            <option value="9">9 Taksit</option>
                            <option value="12">12 Taksit</option>
                            <option value="18">18 Taksit</option>
                            <option value="24">24 Taksit</option>
                            <option value="36">36 Taksit</option>
                        </select>
                        <span asp-validation-for="TotalInstallments" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label asp-for="CategoryId" class="form-label">
                            <i class="bi bi-tags form-icon"></i>Kategori *
                        </label>
                        <select asp-for="CategoryId" asp-items="categories" class="form-select" id="CategoryId"
                            onchange="onCategoryChange()">
                            <option value="">Kategori seÃ§in...</option>
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                        <div class="form-help">Taksit kategorisi (faiz oranÄ±nÄ± belirler)</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 mb-4">
                        <label asp-for="InterestRate" class="form-label">
                            <i class="bi bi-percent form-icon"></i>Faiz OranÄ± (AylÄ±k %)
                            <span id="rateSourceIndicator" class="badge bg-info ms-2" style="display: none;">Piyasa OranÄ±</span>
                        </label>
                        <div class="input-group">
                            <input asp-for="InterestRate" class="form-control" type="number" step="0.01" min="0" max="99.99"
                                placeholder="0.00" onchange="onInterestRateChange()" oninput="onInterestRateChange()"
                                id="InterestRateInput" />
                            <span class="input-group-text">%</span>
                        </div>
                        <span asp-validation-for="InterestRate" class="text-danger"></span>

                        <!-- Market Rate Information -->
                        <div id="marketRateInfo" class="form-help" style="display: none;">
                            <i class="bi bi-graph-up me-1"></i>
                            <span id="marketRateText">Kategori iÃ§in Ã¶nerilen piyasa oranÄ±</span>
                        </div>

                        <!-- Rate Comparison -->
                        <div id="rateComparisonInfo" class="mt-1" style="display: none;">
                            <small id="comparisonText" class="text-success"></small>
                        </div>

                        <!-- Manual Override Notice -->
                        <div id="manualOverrideNotice" class="mt-1" style="display: none;">
                            <small class="text-warning">
                                <i class="bi bi-pencil me-1"></i>Manuel olarak deÄŸiÅŸtirildi
                            </small>
                        </div>

                        <!-- Smart Rate Controls -->
                        <div class="mt-2" id="rateControlsSection">
                            <div id="marketRateControls" style="display: none;">
                                <small class="text-success d-block mb-1">
                                    <i class="bi bi-check-circle me-1"></i>Piyasa oranÄ± kullanÄ±lÄ±yor
                                </small>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="enableManualRate()"
                                    title="Manuel olarak deÄŸiÅŸtir">
                                    <i class="bi bi-pencil me-1"></i>Manuel DeÄŸiÅŸtir
                                </button>
                            </div>
                            <div id="manualRateControls" style="display: none;">
                                <small class="text-muted d-block mb-1">HÄ±zlÄ± Ayarlama:</small>
                                <div class="btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-success btn-sm me-1"
                                        onclick="setManualRate(0)" title="Faizsiz">%0</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="useMarketRate()"
                                        title="Piyasa oranÄ±na dÃ¶n" id="backToMarketBtn">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i>Piyasa OranÄ±
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

        <div class="mb-4">
            <label asp-for="FirstPaymentDate" class="form-label">
                <i class="bi bi-calendar form-icon"></i>Ä°lk Ã–deme Tarihi *
            </label>
            <input asp-for="FirstPaymentDate" class="form-control" type="date" />
            <span asp-validation-for="FirstPaymentDate" class="text-danger"></span>
            <div class="form-help">Ä°lk taksit Ã¶demesinin yapÄ±lacaÄŸÄ± tarih</div>
        </div>

        <!-- Calculation Preview -->
        <div class="calculation-preview" id="calculationPreview" style="display: none;">
            <h6 class="mb-3">ðŸ“Š Ã–deme PlanÄ± Ã–nizlemesi</h6>

            <div class="preview-row">
                <span class="preview-label">Ana Para:</span>
                <span class="preview-value" id="previewPrincipal">â‚º0,00</span>
            </div>

            <div class="preview-row">
                <span class="preview-label">Faiz OranÄ±:</span>
                <span class="preview-value" id="previewRate">%0,00</span>
            </div>

            <div class="preview-row">
                <span class="preview-label">Taksit SayÄ±sÄ±:</span>
                <span class="preview-value" id="previewCount">-</span>
            </div>

            <div class="preview-row">
                <span class="preview-label">AylÄ±k Ã–deme:</span>
                <span class="preview-value total" id="previewMonthly">â‚º0,00</span>
            </div>

            <div class="preview-row" id="interestRow" style="display: none;">
                <span class="preview-label">Toplam Faiz:</span>
                <span class="preview-value" id="previewInterest" style="color: var(--orange);">â‚º0,00</span>
            </div>

            <div class="preview-row" id="totalCostRow" style="display: none;">
                <span class="preview-label">Toplam Ã–denecek:</span>
                <span class="preview-value" id="previewTotalCost"
                    style="color: var(--orange); font-weight: 700;">â‚º0,00</span>
            </div>

            <div class="preview-row">
                <span class="preview-label">Son Ã–deme Tarihi:</span>
                <span class="preview-value" id="previewEndDate">-</span>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6 mb-2">
                <a asp-action="Index" class="btn-secondary-action w-100">
                    <i class="bi bi-arrow-left me-2"></i>Ä°ptal Et
                </a>
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn-primary-action w-100">
                    <i class="bi bi-floppy me-2"></i>Taksitli AlÄ±ÅŸveriÅŸ OluÅŸtur
                </button>
            </div>
        </div>
        </form>
    </div>
</div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="~/js/installment.js"></script>
}